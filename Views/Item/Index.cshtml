@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<IEnumerable<Cofo.Modules.EmailRegistrationWall.Models.Item>>

@using System.Text.RegularExpressions
@using DotNetNuke.Web.Mvc.Helpers
@using Cofo.Modules.GenPageBuilder.Models
@using Cofo.Modules.ActiveDirectory.ADLib
@using System.Linq
@using DotNetNuke.Collections

@{
    bool userHasAuthorization = Request.IsAuthenticated && ADAccess.IsAuthorized(Dnn.User, (string)Dnn.ModuleContext.Settings.GetValueOrDefault("ActiveDirectoryGroups", ""));
}
<style>
    #loadingDiv {
        margin-bottom: 1200px;
        position: relative;
        height: 100%;
        width: 100%;
        display: block;
    }

    #Items-@Dnn.ModuleContext.ModuleId {
        position: relative; /* Make sure it's not positioned absolutely or fixed */
        z-index: 1; /* Ensure the other content appears above the loadingDiv */
    }
</style>

<div id="loadingDiv"></div>
<div id="Items-@Dnn.ModuleContext.ModuleId">
    <div class="container">
        <div class="m-4">

            <div class="form-group">
                <label for="EmailInput">Email Address</label>
                <input name="EmailInput" id="EmailInput" class="form-control" aria-describedby="emailHelp" placeholder="Enter email" type="email" required="">
            </div>
            <p><font color="red"><span></span></font></p>
            <a type="submit" name="SubmitEmail" value="Connect" id="SubmitEmail" class="btn btn-primary" href="">Connect</a>

        </div>
    </div>
</div>

<script>
    $(document).ready(async function () {
        if (!@userHasAuthorization.ToString().ToLower()) {
            if ($('.DnnModule').length) {
                // add visibility: hidden;
                $('.DnnModule ').attr('style', 'visibility: hidden;');
                // Remove visibility: hidden;
                $('.DnnModule-EmailRegistrationWall').attr('style', 'visibility: visible;');
            }
        }
        $('#loadingDiv').hide()
    });

    function actionRequest(link) {
        return new Promise((resolve, reject) => {
            $.ajax({
                type: "POST",
                url: link,
                contentType: "application/json; charset=utf-8",
                contentType: false,
                processData: false,
                dataType: "json",
                success: function (res) {
                    resolve(true);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    resolve(false);
                }
            });
        });
    }

    $('#SubmitEmail').on('click', function (e) {

        e.preventDefault(); // prevent the default form submission

        (async () => {
            var emailValue = $('#EmailInput').val(); // Get the value of the email input
            var link = $('@Html.ActionLink(".", "Submit", "Item", "", "", "", new { Email = "__REPLACE__" }, new { })').attr('href');
            link = link.replace("__REPLACE__", emailValue); // Replace placeholder with the actual email value
            let result = await actionRequest(link)

            if (result) {
                $('#loadingDiv').show()
                if ($('.DnnModule').length) {
                    $('.DnnModule ').attr('style', 'visibility: visible;');
                    $('.DnnModule-EmailRegistrationWall ').hide();
                }
                $('#EmailInput').val('');
                $('#loadingDiv').hide()
            }
        })()
    });
</script>